# Batch Process TDX (通达信数据批量处理工具)

本项目提供了一个高效的 Python 脚本 `batch_process_tdx.py`，用于将通达信（TDX）导出的二进制日线数据（`.day` 文件）批量转换为 CSV 格式，并自动完成**前复权**（Forward Adjustment）处理。

## 简介

通达信的本地日线数据以二进制格式存储，且不直接包含复权信息。在进行量化回测或数据分析时，通常需要将这些数据转换为易读的 CSV 格式，并进行复权处理以反映股票的真实价格走势。

本脚本的主要功能包括：
- **二进制解析**：直接读取通达信 `.day` 文件结构。
- **自动前复权**：结合通达信权息文件（`gbbq`）计算复权因子，处理分红、送股、配股等事件。
- **并行处理**：利用多进程（Multiprocessing）提高大规模数据的处理速度。
- **灵活过滤**：支持仅处理 A 股股票，过滤掉指数或其他非个股数据。

## 原理

### 1. 数据解析
脚本解析 `.day` 文件中每 32 字节一条的记录，提取日期、开盘价、最高价、最低价、收盘价、成交金额和成交量。

### 2. 复权计算
脚本使用 `pytdx` 库读取 `gbbq` (权息数据) 文件。复权逻辑遵循标准的复权公式：
- **除权价计算**：`P_ex = (收盘价 - 每股红利 + 配股价 * 配股比例) / (1 + 送转比例 + 配股比例)`
- **前复权因子**：从当前时间向历史追溯，累计计算每个除权节点的缩减比例，最终将历史价格映射到当前价格体系中。

### 3. 多进程调度
通过 Python 的 `ProcessPoolExecutor`，脚本可以将成千上万个文件的转换任务分配到多个 CPU 核心并行执行，极大地缩短了处理时间。

## 使用方法

### 环境要求
确保已安装必要的 Python 依赖：
```bash
pip install pandas pytdx
```

### 快速开始
1. **准备数据**：确保你有通达信的 `vipdoc` 文件夹（包含 `sh/lday` 和 `sz/lday`）以及权息文件 `gbbq`。
2. **运行脚本**：
   ```bash
   python batch_process_tdx.py --gbbq ./gbbq --data-dir ./data --output-dir ./data_csv --stocks-only
   ```

### 命令行参数
| 参数 | 说明 | 默认值 |
| :--- | :--- | :--- |
| `--data-dir` | 通达信数据根目录（应包含 sh/sz 子目录） | `data` |
| `--output-dir` | CSV 文件输出目录 | `data_csv` |
| `--gbbq` | 通达信权息文件 `gbbq` 的路径 | `gbbq` |
| `--workers` | 并行任务的进程数 | `4` |
| `--stocks-only` | 是否仅处理 A 股股票（过滤指数等） | `False` |

### 目录结构示例
```text
.
├── batch_process_tdx.py
├── gbbq                  # 权息文件
├── data/                 # 输入目录
│   ├── sh/lday/*.day
│   └── sz/lday/*.day
└── data_csv/             # 输出目录（脚本自动生成）
    ├── sh/lday/*.csv
    └── sz/lday/*.csv
```

## 注意事项
- 请确保 `gbbq` 文件路径正确，否则生成的 CSV 将仅包含原始不复权价格。
- `adj_close`, `adj_open` 等列即为前复权后的价格数据。
